"""URL白名单规则数据访问层。"""

from typing import List, Optional

from sqlalchemy import select

from app.core.database import DatabaseManager
from app.entities.url_whitelist_entity import UrlWhitelistEntity
from app.utils.logging.crud_logger import CrudLogger


class UrlWhitelistCrud:
    """URL白名单CRUD操作类。

    提供白名单规则的增删改查操作，使用异步数据库会话。
    """

    def __init__(
        self,
        db_manager: DatabaseManager,
        crud_logger: CrudLogger,
    ) -> None:
        """初始化白名单CRUD。

        Args:
            db_manager: 数据库管理器实例。
            crud_logger: CRUD日志记录器。
        """
        self._db_manager = db_manager
        self._crud_logger = crud_logger

    async def create(
        self,
        rule_type: str,
        rule_value: str,
        description: Optional[str] = None,
    ) -> UrlWhitelistEntity:
        """创建白名单规则。

        Args:
            rule_type: 规则类型（DOMAIN/DOMAIN-SUFFIX/DOMAIN-KEYWORD）。
            rule_value: 规则值。
            description: 规则描述。

        Returns:
            创建的白名单规则实体。
        """
        async with self._db_manager.get_session() as session:
            rule = UrlWhitelistEntity(
                rule_type=rule_type,
                rule_value=rule_value,
                description=description,
            )
            session.add(rule)
            await session.flush()
            await session.refresh(rule)

            self._crud_logger.log_create(
                "创建白名单规则",
                {"rule_type": rule_type, "rule_value": rule_value},
            )

            return rule

    async def get_all_active(self) -> List[UrlWhitelistEntity]:
        """获取所有启用的白名单规则。

        Returns:
            启用的白名单规则列表。
        """
        async with self._db_manager.get_session() as session:
            query = select(UrlWhitelistEntity).where(
                UrlWhitelistEntity.is_active == True
            )
            result = await session.execute(query)
            rules = list(result.scalars().all())

            self._crud_logger.log_read(
                "获取所有启用的白名单规则",
                {"count": len(rules)},
            )

            return rules

    async def get_all(self) -> List[UrlWhitelistEntity]:
        """获取所有白名单规则。

        Returns:
            白名单规则列表。
        """
        async with self._db_manager.get_session() as session:
            query = select(UrlWhitelistEntity).order_by(
                UrlWhitelistEntity.created_at.desc()
            )
            result = await session.execute(query)
            rules = list(result.scalars().all())

            self._crud_logger.log_read(
                "获取所有白名单规则",
                {"count": len(rules)},
            )

            return rules

    async def get_by_id(self, rule_id: int) -> Optional[UrlWhitelistEntity]:
        """根据ID获取白名单规则。

        Args:
            rule_id: 规则ID。

        Returns:
            白名单规则实体或None。
        """
        async with self._db_manager.get_session() as session:
            query = select(UrlWhitelistEntity).where(UrlWhitelistEntity.id == rule_id)
            result = await session.execute(query)
            rule = result.scalar_one_or_none()

            self._crud_logger.log_read(
                "根据ID查询白名单规则",
                {"rule_id": rule_id, "found": rule is not None},
            )

            return rule

    async def update(
        self,
        rule_id: int,
        rule_type: Optional[str] = None,
        rule_value: Optional[str] = None,
        description: Optional[str] = None,
        is_active: Optional[bool] = None,
    ) -> Optional[UrlWhitelistEntity]:
        """更新白名单规则。

        Args:
            rule_id: 规则ID。
            rule_type: 规则类型。
            rule_value: 规则值。
            description: 规则描述。
            is_active: 是否启用。

        Returns:
            更新后的规则实体，如果不存在返回None。
        """
        async with self._db_manager.get_session() as session:
            query = select(UrlWhitelistEntity).where(UrlWhitelistEntity.id == rule_id)
            result = await session.execute(query)
            rule = result.scalar_one_or_none()

            if not rule:
                self._crud_logger.log_update(
                    "更新白名单规则失败-规则不存在",
                    {"rule_id": rule_id, "success": False},
                )
                return None

            if rule_type is not None:
                rule.rule_type = rule_type
            if rule_value is not None:
                rule.rule_value = rule_value
            if description is not None:
                rule.description = description
            if is_active is not None:
                rule.is_active = is_active

            await session.flush()
            await session.refresh(rule)

            self._crud_logger.log_update(
                "更新白名单规则",
                {"rule_id": rule_id, "success": True},
            )

            return rule

    async def delete(self, rule_id: int) -> bool:
        """删除白名单规则。

        Args:
            rule_id: 规则ID。

        Returns:
            是否删除成功。
        """
        async with self._db_manager.get_session() as session:
            query = select(UrlWhitelistEntity).where(UrlWhitelistEntity.id == rule_id)
            result = await session.execute(query)
            rule = result.scalar_one_or_none()

            if not rule:
                self._crud_logger.log_delete(
                    "删除白名单规则失败-规则不存在",
                    {"rule_id": rule_id, "success": False},
                )
                return False

            await session.delete(rule)
            await session.flush()

            self._crud_logger.log_delete(
                "删除白名单规则",
                {"rule_id": rule_id, "success": True},
            )

            return True
